BEGIN
  -- 자식 테이블부터 DROP (FK 때문)
  EXECUTE IMMEDIATE 'DROP TABLE ledger_entries CASCADE CONSTRAINTS PURGE';
  EXECUTE IMMEDIATE 'DROP TABLE holds CASCADE CONSTRAINTS PURGE';

  -- 부모 테이블 DROP
  EXECUTE IMMEDIATE 'DROP TABLE transactions CASCADE CONSTRAINTS PURGE';

  -- 부모 테이블부터 CREATE
  EXECUTE IMMEDIATE 'CREATE TABLE transactions (
    txn_id NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1) PRIMARY KEY,
    idempotency_key VARCHAR2(100) NOT NULL UNIQUE,
    src_account_id NUMBER,
    dst_account_id NUMBER,
    dst_bank VARCHAR2(10),
    amount NUMBER(15,2) NOT NULL,
    type CHAR(1) NOT NULL,
    status CHAR(1) DEFAULT ''1'',
    result VARCHAR2(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  )';

  -- 자식 테이블 CREATE
  EXECUTE IMMEDIATE 'CREATE TABLE holds (
    hold_id NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1) PRIMARY KEY,
    txn_id NUMBER NOT NULL UNIQUE,
    account_id NUMBER NOT NULL,
    amount NUMBER(15,2) NOT NULL,
    status CHAR(1) DEFAULT ''1'',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_hold_txn FOREIGN KEY (txn_id) REFERENCES transactions(txn_id)
  )';

  EXECUTE IMMEDIATE 'CREATE TABLE ledger_entries (
    entry_id NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1) PRIMARY KEY,
    txn_id NUMBER NOT NULL,
    account_id NUMBER NOT NULL,
    amount NUMBER(15,2) NOT NULL,
    balance_after NUMBER(15,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_entry_txn FOREIGN KEY (txn_id) REFERENCES transactions(txn_id)
  )';

  -- 계정 초기화
  UPDATE accounts SET balance = 0, hold_amount = 0;
  UPDATE accounts SET balance = 100000000 WHERE account_id IN (300001, 300002, 300003, 300004, 300005);

  COMMIT;
END;

-- 확인 쿼리 (옵션)
-- SELECT 'transactions' as table_name, COUNT(*) as row_count FROM transactions
-- UNION ALL
-- SELECT 'holds', COUNT(*) FROM holds
-- UNION ALL
-- SELECT 'ledger_entries', COUNT(*) FROM ledger_entries
-- UNION ALL
-- SELECT 'accounts with balance', COUNT(*) FROM accounts WHERE balance > 0;
