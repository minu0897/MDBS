DECLARE
  v_count NUMBER;
BEGIN
  -- 1. 데이터 삭제
  DELETE FROM ledger_entries;
  DELETE FROM holds;
  DELETE FROM transactions;

  -- 2. 계정 잔액 초기화
  UPDATE accounts SET balance = 0, hold_amount = 0;
  UPDATE accounts SET balance = 100000000 WHERE account_id IN (300001, 300002, 300003, 300004, 300005);

  COMMIT;

  -- 3. IDENTITY 시퀀스 리셋 (DROP -> RECREATE)
  BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE transactions MODIFY txn_id DROP IDENTITY';
  EXCEPTION WHEN OTHERS THEN NULL;
  END;

  EXECUTE IMMEDIATE 'ALTER TABLE transactions MODIFY txn_id GENERATED BY DEFAULT AS IDENTITY (START WITH 1)';

  BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE holds MODIFY hold_id DROP IDENTITY';
  EXCEPTION WHEN OTHERS THEN NULL;
  END;

  EXECUTE IMMEDIATE 'ALTER TABLE holds MODIFY hold_id GENERATED BY DEFAULT AS IDENTITY (START WITH 1)';

  BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE ledger_entries MODIFY entry_id DROP IDENTITY';
  EXCEPTION WHEN OTHERS THEN NULL;
  END;

  EXECUTE IMMEDIATE 'ALTER TABLE ledger_entries MODIFY entry_id GENERATED BY DEFAULT AS IDENTITY (START WITH 1)';

  COMMIT;
END;

-- 확인 쿼리 (옵션)
-- SELECT 'transactions' as table_name, COUNT(*) as row_count FROM transactions
-- UNION ALL
-- SELECT 'holds', COUNT(*) FROM holds
-- UNION ALL
-- SELECT 'ledger_entries', COUNT(*) FROM ledger_entries
-- UNION ALL
-- SELECT 'accounts with balance', COUNT(*) FROM accounts WHERE balance > 0;
