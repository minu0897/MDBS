############################
# base (공통 레이어)
############################
FROM python:3.11-slim AS base
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl gcc pkg-config \
    libpq-dev default-libmysqlclient-dev libmariadb-dev \
    && rm -rf /var/lib/apt/lists/*
COPY BE/requirements.txt ./requirements.txt
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
RUN useradd -m flask && chown -R flask:flask /app
EXPOSE 5000

############################
# dev (핫리로드)
############################
FROM base AS dev
ENV FLASK_ENV=development
USER flask
# dev는 flask run
CMD ["flask", "--app", "BE/app.py", "run", "--host=0.0.0.0", "--port=5000", "--debug"]

############################
# prod (gunicorn)
############################
FROM base AS prod
ENV GUNICORN_WORKERS=2 GUNICORN_TIMEOUT=60
USER flask
# prod는 gunicorn
CMD ["gunicorn", "--chdir", "BE", "--bind", "0.0.0.0:5000", "--workers", "2", "--timeout", "60", "--access-logfile", "-", "--error-logfile", "-", "--log-level", "info", "app:app"]
